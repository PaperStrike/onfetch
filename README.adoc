= onfetch
:repo: https://github.com/PaperStrike/onfetch
:q-a: {repo}/discussions/categories/q-a
:contributing: {repo}/blob/main/.github/CONTRIBUTING.md
:mdn-api: https://developer.mozilla.org/en-US/docs/Web/API

:mdn-fetch-func: {mdn-api}/WindowOrWorkerGlobalScope/fetch
:mdn-request-api: {mdn-api}/Request
:mdn-response-api: {mdn-api}/Response

Mock {mdn-fetch-func}[`fetch()`] with native {mdn-request-api}[`Request`] / {mdn-response-api}[`Response`] API.

Works with `node-fetch`, `whatwg-fetch`, `cross-fetch`, and mainly, real browsers.

'''

🐿️ Jump to
link:#callback[Callback],
link:#delay[Delay],
link:#redirect[Redirect],
link:#times[Times],
link:#options[Options],
{q-a}[Q&A],
or
{contributing}[Contributing Guide].

[#basic]
== Basic
:mdn-headers-api: {mdn-api}/Headers

Start with `onfetch`, pass the same params as constructing a {mdn-request-api}[`Request`] object. Then `reply` as constructing a {mdn-response-api}[`Response`] object.

[source,js]
----
import onfetch from 'onfetch';

onfetch('/simple').reply('path');
onfetch('/post', { method: 'POST' })
  .reply('received');
onfetch('/down').reply(null, { status: 500 });
----

In Node, in addition to setting up global {mdn-fetch-func}[`fetch`], you also need to set up global {mdn-headers-api}[`Headers`], {mdn-request-api}[`Request`], and {mdn-response-api}[`Response`].

[#matching]
=== Matching

How `onfetch` uses your params to match a {mdn-request-api}[`Request`].

To keep this simple and efficient, we don't and won't support {mdn-request-api}/body[`body`] matching. You will have to put your own processing code into a link:#callback[reply callback] when needed.

[#string]
==== String
:mdn-url-api: {mdn-api}/URL

A string matches the request's URL if all the following checks pass:

. Split into three parts. Path, query string and hash.
. Check if the path matches the request's path.
. For the query string and hash, if not empty, check if it matches the request's one.

[source,js]
----
onfetch('/string').persist();

fetch('/string'); // match
fetch('/string?query'); // match
fetch('/string#hash'); // match
----

[source,js]
----
onfetch('/string?specify-query').persist();

fetch('/string'); // not match
fetch('/string?other-query'); // not match
fetch('/string?specify-query'); // match
fetch('/string?specify-query#hash'); // match
----

The use of link:#persist[`persist()`] allows the above `onfetch` rules to match an unlimited number of times.

[#request-init]
==== RequestInit
:idl-request-init: https://fetch.spec.whatwg.org/#requestinit

The second param, a {idl-request-init}[`RequestInit`] object, matches the {mdn-request-api}[`Request`] object, when all the checks in the following steps pass:

. Deconstruct `headers`, `body`, `window` and the _rest parts_ from the init.
. Check if each header in `headers` has a match in the request's headers.
. Check if each part in the _rest parts_ has a match in the {mdn-request-api}[`Request`] object.

[source,js]
----
onfetch('', {
  method: 'GET',
  headers: {
    'Content-Type': 'text/plain',
  },
}).persist();

// not match
fetch('', { method: 'GET' });

// not match
fetch('', {
  method: 'POST',
  headers: {
    'Content-Type': 'text/plain',
  },
});

// match
fetch('', {
  cache: 'no-cache',
  method: 'GET',
  headers: {
    'Accept': 'text/html',
    'Content-Type': 'text/plain',
  },
});
----

[#regexp]
==== RegExp
:mdn-regexp-api: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp

Other than using strings, you can also pass a {mdn-regexp-api}[`RegExp`] as the first arg to test the request's URL.

[source,js]
----
// Match URLs that ends with '.foo'.
onfetch(/\.foo$/).reply('bar');
----

Put it in consideration that {mdn-regexp-api}[`RegExp`] here test against the *entire URL string*, which means, if this `onfetch` rule needn't care about the query string nor the hash, write it like:
[source,js]
----
// Use regexp that
// allows any trailing query string and hash.
onfetch(/^[^?#]*\.foo([?#]|$)/).reply('bar');
----

[#request]
==== Request
You can also pass a {mdn-request-api}[`Request`] object as the first arg, to match the request in a manner similar with the link:#request-init[`RequestInit` matcher].

[#callback]
== Callback
:idl-body-init: https://fetch.spec.whatwg.org/#bodyinit
:mdn-promise-api: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise

Other than `reply` as constructing a {mdn-response-api}[`Response`], you can also pass a callback function to form the response.

Your callback will receive two params, the first one points to the {mdn-request-api}[`Request`] object, the second one gives you both the original and the mocked `fetch`.

Remember to return a {mdn-response-api}[`Response`], {idl-body-init}[`BodyInit`], `null`, or a {mdn-promise-api}[`Promise`] that resolves to one of them.

[source,js]
----
onfetch('').reply((request, fetchers) => {
  const example = request.headers.get('One');
  if (example === 'original') {
    return fetchers.original(request);
  }
  if (example === 'mocked') {
    return fetchers.mocked('/mocked');
  }
  return 'default-response';
});
----

[#pass-through]
=== passThough

You can also use this built-in callback to send requests via the original `fetch`.

[source,js]
----
import onfetch, { passThrough } from 'onfetch';
onfetch('/use-original').reply(passThrough);
----

[#delay]
== Delay

[source,js]
----
// Delay 200ms before reply.
onfetch('').delay(200).reply('');
----

The order of `delay`, `redirect`, and `reply` does not affect the result.

[source,js]
----
// Same effect.
onfetch('').reply('').delay(200);
----

The delay duration accumulates.

[source,js]
----
// Delay 400ms before reply.
onfetch('').delay(200).delay(300).delay(-100).reply('');
----

[#redirect]
== Redirect

Use `redirect` to redirect the request passed to the link:#callback[reply callback], or change the response' URL if no callback provided.

[source,js]
----
// Redirect the request to '/bar' before reply.
onfetch('/foo').redirect('/bar').reply((req) => req.url);

// Logs 'https://localhost/bar'
fetch('/foo').then(console.log);
----

The order of `delay`, `redirect`, and `reply` does not affect the result.

[source,js]
----
// Same effect.
onfetch('/foo').reply((req) => req.url).redirect('/bar');
----

[#times]
== Times

You can specify the number of times to apply the `onfetch` rule via the `times` function. It accepts an integer as the number of applications of the rule.

[source,js]
----
// Apply this rule 5 times.
onfetch('/foo').times(5).reply('bar');
----

You can specify the times at any time as long as you store the reference of the `onfetch` rule somewhere.

[source,js]
----
const onFoo = onfetch('/foo').reply('/bar');

fetch('/foo'); // match

// Once again.
onFoo.once();

fetch('/foo'); // match
----

By default, an `onfetch` rule only applies *once*. When the times ran out, it bypasses the match.

[source,js]
----
onfetch('/foo').reply('/bar');
onfetch('/foo').reply('/baz');

fetch('/foo').then(console.log); // logs bar
fetch('/foo').then(console.log); // logs baz
----

Note that when all the `onfetch` rules do not match a request, that request goes to link:#default-rule[`options.defaultRule`].

The `times(n)` doesn't accumulate. It overrides.

[source,js]
----
const onFoo = onfetch('/foo').twice().once().reply('/bar');

fetch('/foo'); // match
fetch('/foo'); // fallback to `defaultRule`
----

[#once]
=== `once()`

A syntactic sugar for `rule.times(1)`.

[#twice]
=== `twice()`

Syntactic sugar for `rule.times(2)`.

[#thrice]
=== `thrice()`

Sugar for `rule.times(3)`.

[#persist]
=== `persist()`

For `rule.times(Infinity)`.

[#options]
== Options

Configurable via `onfetch.config`.

[#default-rule]
=== Default rule

The rule used when all `onfetch` rules failed to match a request. You can form a rule by constructing a `InterceptRule` object, which accepts the same params as `onfetch`.

[source,js]
----
import onfetch, { InterceptRule } from 'onfetch';
onfetch.config({
  defaultRule: new InterceptRule('').reply('default'),
});
----

Defaults to:

[source,js]
----
new InterceptRule('').reply((request) => {
  throw new Error('No onfetch rule matches this fetch request', {
    cause: request,
  });
})
----

[#q-a]
== Q&A

Checkout our {q-a}[Q&A Discussions] for your answers. 👍

[#contributing]
== Contributing

Checkout our {contributing}[Contributing Guide] please. 👍

[#license]
== License
:license: {repo}/blob/main/LICENSE

{license}[ISC]
